# ===============================================================
# production.rds
#
# Project: Revolution Now
#
# Created by dsicilia on 2022-05-31.
#
# Description: Config info for colony production.
#
# ===============================================================
# ss
include "ss/colony-enums.rds.hpp"
include "ss/terrain-enums.rds.hpp"
include "ss/difficulty.rds.hpp"

# refl
include "refl/cdr.hpp"
include "refl/enum-map.hpp"

# cdr
include "cdr/ext-base.hpp"
include "cdr/ext-builtin.hpp"
include "cdr/ext-std.hpp"

# base
include "base/maybe.hpp"

# C++ standard library
include "<unordered_set>"

namespace "rn"

sumtype.BuildingBonus {
  none {},
  same {
    # Same bonus for use/put. For a +50% bonus this would be 50.
    # Could be zero.
    bonus 'int',
  },
  factory {
    # Factory level buildings produce a bonus, but what sets them
    # apart is that they put out more than they consume, unlike
    # the bonuses from level 2 buildings. For example, an Iron
    # Works would have a percent_increase_use of 100 because it
    # uses the same amount as the level 2 Blacksmiths Shop. But
    # the Iron Works will have a percent_increase_put of 150 be-
    # cause it is extra efficient in then it will produce +50%
    # more goods than it is consuming.
    use_bonus 'int',
    put_bonus 'int',
  },
}

struct.IndoorProduction {
  # Amount produced per turn by a petty criminal working in an
  # indoor job (e.g. rum distiller).
  petty_criminal_base_production 'int',

  # Amount produced per turn by a native convert working in an
  # indoor job (e.g. rum distiller). In the original game this is
  # equivalent to a petty criminal.
  native_convert_base_production 'int',

  # Amount produced per turn by an indentured servant working in
  # an indoor job (e.g. rum distiller).
  indentured_servant_base_production 'int',

  # Amount produced per turn by a free colonist working in an in-
  # door job (e.g. rum distiller) or by an expert colonist
  # working a job that they are not an expert at.
  non_expert_base_production 'int',

  # Amount produced by an expert colonist working in an indoor
  # job matching their expertise (e.g. master run distiller
  # working on producing rum).
  expert_base_production 'int',

  # William Penn crosses production bonus percent.
  william_penn_crosses_bonus 'int',
}

sumtype.OutdoorJobBonus {
  none {},
  add {
    # In the original game, it seems that when bonuses are addi-
    # tive, they can sometimes have different values for experts
    # and non-experts.
    non_expert 'int',
    expert     'int',
  },
  mul {
    by 'int',
  },

  _features { validation, equality }
}

struct.NonResourceOverride {
  non_expert 'int',
  expert     'int',
  required_resources 'std::unordered_set<e_natural_resource>',
}

struct.OutdoorJobProduction {
  # In general the order in which these are applied matters be-
  # cause some of them are additive and some multiplicative. When
  # they are all additive, as in e.g. the case of farming in the
  # original game, the order does not matter. In the case of e.g.
  # cotton on prairie tiles, the original game appears to compute
  # in this order, where each is present:
  #
  #   1. base:        3
  #   2. resource:   x2
  #   3. plow:       +1
  #   4. river:      +1 (minor)
  #   5. expert:     x2
  #
  # So let's say that we have an expert cotton planter working on
  # a square with prime cotton, a river, and plowed, we'd have:
  #
  #   production = ((3*2)+1+1)*2 = 16
  #
  # Note that none of these are mutually exclusive; i.e., when a
  # tile is eligible for both plow and river bonuses, they can
  # both be present and will be cumulative.
  minor_river_bonus 'OutdoorJobBonus_t',
  major_river_bonus 'OutdoorJobBonus_t',
  road_bonus        'OutdoorJobBonus_t',
  plow_bonus        'OutdoorJobBonus_t',
  expert_bonus      'OutdoorJobBonus_t',

  # If the worker is a native convert then its production will be
  # computed from that of a free colonist, but with this bonus
  # added. In the original game, this bonus is always +1 for
  # planting-based jobs as well as for fur trapping and fishing,
  # and is +0 for everything else. Note that this bonus is ap-
  # plied after all other bonuses, and is only applied if the
  # production value at that point is non-zero.
  native_bonus 'OutdoorJobBonus_t',

  # For ocean tiles.
  coast_bonus    'OutdoorJobBonus_t',

  resource_bonus 'refl::enum_map<e_natural_resource, OutdoorJobBonus_t>',

  # These are for a free colonist.
  base_productions 'refl::enum_map<e_terrain, int>',

  # When this has a value, it means that, when the tile has no
  # resource, the entire calculation will be completely over-
  # ridden but the numbers here. That means that what would oth-
  # erwise be the base production and various bonuses will not be
  # applied, with the exception of the Sons of Liberty
  # bonus/penalty. This is to allow reproducing the behavior of
  # some versions of the original game with regard to silver pro-
  # duction, which seems to follow all of the usual formulas but
  # only when a tile has a silver (or depleted silver) resource.
  non_resource_override 'base::maybe<NonResourceOverride>',
}

struct.OutdoorProduction {
  jobs 'refl::enum_map<e_outdoor_job, OutdoorJobProduction>',

  # Of the 8 tiles that border an ocean square, how many of them
  # (at least) have to be land in order for it to be considered a
  # "coast" (and thus recieve the associated fishing bonus).
  num_land_tiles_for_coast 'int',
}

struct.CenterSquareProduction {
  # For some reason the original game seems to apply the river
  # bonus to the production of the secondary good, but not to
  # food.
  apply_river_bonus_on_food 'bool',
  apply_river_bonus_on_secondary 'bool',

  # It seems that in the original game, the base values of food
  # production (on the harder difficulty levels) are tweaked from
  # their standard values. Even on the easy difficulty levels, it
  # appears that the base values are still not their standard
  # values, but instead are computed from these viceroy-level
  # base values. This is a bit strange, since it prevents the
  # player from calculating center square production from the
  # standard terrain production docs, but perhaps was done for
  # game balancing.
  viceroy_base_food 'refl::enum_map<e_terrain, int>',

  # It appears that the original game uses a set of base produc-
  # tion values on the "conquistador", "governor", and "viceroy"
  # difficulty levels. Then the "explorer" values are those +1,
  # and the "discoverer" values are viceroy values +2. To empha-
  # size, these bonus are added to the values specified for the
  # viceroy level above.
  food_bonus_by_difficulty 'refl::enum_map<e_difficulty, int>',

  # For some reason the original game does not seem to apply ei-
  # ther the road bonus or the plow bonus to secondary good pro-
  # duction (only applies the river bonus), despite the fact that
  # colony squares are supposed to have roads on them and can be
  # plowed.
  apply_road_bonus_on_secondary 'bool',
  apply_plow_bonus_on_secondary 'bool',

  # It appears that the original game that all difficulty levels
  # yield the same except for "discoverer", which gets +1.
  secondary_bonus_by_difficulty 'refl::enum_map<e_difficulty, int>',

  _features { validation, equality }
}

struct.config_production_t {
  # How many crosses are produced by a colony just by virtue of
  # it existing (i.e., with no churches or cathedrals)?
  base_crosses 'int',

  indoor_production 'IndoorProduction',

  outdoor_production 'OutdoorProduction',

  # The number of items that are automatically produced by vir-
  # tual of a building existing. Most buildings have "zero" for
  # this.
  free_building_production 'refl::enum_map<e_colony_building, int>',

  # This describes the nature of the bonus that you get from a
  # building on production in terms of percent increases. Note
  # that the base value to which the percentage is applied here
  # may or may not include the base/free production, depending on
  # what we're talking about. For example, the percent bonus for
  # a Cathedral does not seem to apply to the base production of
  # the building, while the percent bonus of a Printing Press and
  # Newspaper do seem to get applied to the base production. Note
  # that the original game appears to ROUND DOWN on 1/2.
  building_production_bonus 'refl::enum_map<e_colony_building, BuildingBonus_t>',

  # Config for what and how much gets produced in the center
  # square. Note that the secondary good is selected by choosing
  # the good that yields most; it is not hard-coded in the config
  # for each terrain type.
  center_square_production 'CenterSquareProduction',

  _features { validation, equality }
}

config.production {}
